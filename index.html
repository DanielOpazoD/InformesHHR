<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro Clínico – Hospital Hanga Roa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --gap-y:6px; --fs:13px; }
    body{ font-family: Arial, sans-serif; font-size: var(--fs); color:#1f2937; background:#fff; margin:0; }
    .topbar{ position:sticky; top:0; z-index:10000; background:#111827; color:#fff; padding:8px 12px; display:flex; gap:8px; align-items:center; justify-content:flex-end; box-shadow:0 2px 6px rgba(0,0,0,.2); }
    .topbar .btn{ background:#374151; color:#fff; border:0; border-radius:8px; padding:6px 10px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
    .topbar .btn:hover{ background:#4b5563; }
    .topbar .inp{ background:#1f2937; color:#fff; border:1px solid #4b5563; border-radius:8px; padding:6px 8px; }

    .wrap{ padding:12px; }
    .sheet{ position:relative; max-width:900px; margin:0 auto; background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:10px 12px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:4px 8px; }
    .lbl{ font-weight:600; color:#1e40af; margin-bottom:2px; }
    .inp, .txt{ width:100%; border:1px solid #d1d5db; border-radius:6px; padding:6px 8px; line-height:1.25; }
    .txt{ min-height:88px; }
    .sec{ margin-top:10px; position:relative; }
    .title{ font-weight:800; color:#1e40af; text-align:center; margin:6px 0 8px; font-size:16px; }
    .subtitle[contenteditable="true"]{ font-weight:700; color:#111827; margin:6px 0 4px; }
    .row{ display:grid; grid-template-columns:140px 1fr auto; gap:6px; align-items:center; margin-bottom:var(--gap-y); }
    .row .row-del{ display:none; }

    /* Panel edición */
    .edit-panel{ position:fixed; right:12px; top:56px; z-index:9999; display:none; background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:8px; box-shadow:0 10px 24px rgba(0,0,0,.12); flex-direction:column; gap:6px; }
    .btn{ display:inline-flex; align-items:center; gap:6px; background:#1e40af; color:#fff; border:0; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .btn:hover{ background:#1b3796; }

    .sec-del{ position:absolute; top:-8px; right:-8px; width:22px; height:22px; border-radius:999px; border:none; background:#ef4444; color:#fff; font-weight:700; line-height:22px; text-align:center; cursor:pointer; box-shadow:0 1px 2px rgba(0,0,0,.15); display:none; }
    .edit-mode .sec-del{ display:inline-flex; align-items:center; justify-content:center; }
    .edit-mode #sec-datos .row .row-del{ display:inline-flex; align-items:center; justify-content:center; background:#ef4444; color:#fff; border:0; border-radius:8px; padding:2px 8px; cursor:pointer; }
    .edit-mode #sec-datos .lbl{ outline:1px dashed #93c5fd; padding:2px 4px; border-radius:4px; }

    @media print{
      .topbar, .edit-panel{ display:none !important; }
      html, body{ height:auto !important; overflow:visible !important; }
      .sheet{ border:none; border-radius:0; padding:14mm; max-width:unset; overflow:visible !important; }
      .txt{ min-height:70px; overflow:visible !important; }
      *::-webkit-scrollbar{ display:none !important; }
      @page { margin:14mm; }
    }
  </style>
</head>
<body>
  <!-- Barra superior -->
  <div class="topbar">
    <select id="titleSelect" class="inp" style="width:auto;">
      <option value="1">Informe médico de traslado - Hospital Hanga Roa</option>
      <option value="2" selected>Evolución médica (FECHA) - Hospital Hanga Roa</option>
      <option value="3">Epicrisis médica</option>
      <option value="4">Epicrisis médica de traslado</option>
      <option value="5">Otro (personalizado)</option>
      <option value="6">Informe médico - Hospital Hanga Roa</option>
    </select>
    <button id="btnPrint" class="btn" type="button">Imprimir / Guardar PDF</button>
    <button id="toggleEdit" class="btn" type="button">Editar secciones</button>
    <button id="exportJson" class="btn" type="button" title="Exportar registro (.json)">Exportar</button>
    <label class="btn" for="importJson" title="Importar registro (.json)">Importar</label>
    <input id="importJson" type="file" accept="application/json" style="display:none" />
  </div>

  <div class="wrap">
    <div class="sheet" id="sheet">
      <img id="logoLeft" src="https://iili.io/FEirDCl.png" class="absolute top-2 left-2 w-16 h-auto opacity-80">
      <img id="logoRight" src="https://iili.io/FEirQjf.png" class="absolute top-2 right-2 w-16 h-auto opacity-80">

      <!-- Panel edición -->
      <div id="editPanel" class="edit-panel">
        <div class="text-sm font-semibold text-slate-700">Edición</div>
        <button id="addSecBtn" class="btn" type="button">Agregar sección</button>
        <button id="delSecBtn" class="btn" type="button">Eliminar última sección</button>
        <hr class="my-1">
        <div class="text-xs text-slate-500">Campos del paciente</div>
        <button id="addPatientFieldBtn" class="btn" type="button" title="Agregar nuevo campo en Información del Paciente">Agregar campo</button>
        <button id="restorePatientBtn" class="btn" type="button" title="Restaurar campos por defecto">Restaurar campos</button>
        <hr class="my-1">
        <button id="restoreBtn" class="btn" type="button" title="Restaurar estructura y contenido por defecto">Restaurar todo</button>
      </div>

      <!-- Título principal -->
      <div id="titleDisplay" class="title" contenteditable="true">Evolución médica (____) - Hospital Hanga Roa</div>

      <!-- Datos Paciente (editable: títulos y filas eliminables) -->
      <div class="sec" id="sec-datos">
        <div class="subtitle" contenteditable="true">Información del Paciente</div>
        <div class="grid-2" id="patientGrid">
          <div class="row" data-field>
            <div class="lbl" contenteditable="true">Nombre</div>
            <input class="inp" id="nombre" placeholder="Nombre Apellido">
            <button class="row-del" title="Eliminar este campo">×</button>
          </div>
          <div class="row" data-field>
            <div class="lbl" contenteditable="true">Rut</div>
            <input class="inp" id="rut">
            <button class="row-del" title="Eliminar este campo">×</button>
          </div>
          <div class="row" data-field>
            <div class="lbl" contenteditable="true">Fecha de nacimiento</div>
            <input type="date" class="inp" id="fecnac">
            <button class="row-del" title="Eliminar este campo">×</button>
          </div>
          <div class="row" data-field>
            <div class="lbl" contenteditable="true">Edad</div>
            <input type="number" class="inp" id="edad" placeholder="años">
            <button class="row-del" title="Eliminar este campo">×</button>
          </div>
          <div class="row" data-field>
            <div class="lbl" contenteditable="true">Fecha de ingreso</div>
            <input type="date" class="inp" id="fing">
            <button class="row-del" title="Eliminar este campo">×</button>
          </div>
          <div class="row" data-field>
            <div class="lbl" contenteditable="true">Fecha del informe</div>
            <input type="date" class="inp" id="finf">
            <button class="row-del" title="Eliminar este campo">×</button>
          </div>
        </div>
      </div>

      <!-- Secciones dinámicas -->
      <div id="sectionsContainer"></div>

      <!-- Datos médico -->
      <div class="sec" style="margin-top:12px;">
        <div class="grid-2">
          <div class="row"><div class="lbl">Nombre médico</div><input class="inp" id="medico"></div>
          <div class="row"><div class="lbl">Especialidad</div><input class="inp" id="esp"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== utilidades de fecha y título ======
    const select=document.getElementById('titleSelect');
    const titleDisplay=document.getElementById('titleDisplay');
    const fechaInput=document.getElementById('finf');
    const fecnac=document.getElementById('fecnac');
    const edad=document.getElementById('edad');

    function parseYMD(str){const[y,m,d]=str.split('-').map(x=>parseInt(x,10));return{y,m,d};}
    function formatDMY(dd,mm,yy){const d=String(dd).padStart(2,'0');const m=String(mm).padStart(2,'0');const y2=String(yy).slice(-2);return`${d}/${m}/${y2}`;}
    function formatDateDMY(str){if(!str||!/\d{4}-\d{2}-\d{2}/.test(str))return'____';const{y,m,d}=parseYMD(str);return formatDMY(d,m,y);}

    function calcEdadY(birthStr,refStr){
      if(!birthStr||!/\d{4}-\d{2}-\d{2}/.test(birthStr))return'';
      let refY,refM,refD;
      if(refStr&&/\d{4}-\d{2}-\d{2}/.test(refStr)){({y:refY,m:refM,d:refD}=parseYMD(refStr));}
      else { const now=new Date(); refY=now.getFullYear(); refM=now.getMonth()+1; refD=now.getDate(); }
      const{y:by,m:bm,d:bd}=parseYMD(birthStr);
      let age=refY-by; if(refM<bm||(refM===bm&&refD<bd)) age--; return String(Math.max(age,0));
    }

    function setTitleFromSelect(){
      const opt=select.value;
      if(opt==='1') titleDisplay.innerText='Informe médico de traslado - Hospital Hanga Roa';
      if(opt==='2') { const fecha=formatDateDMY(fechaInput?.value||''); titleDisplay.innerText=`Evolución médica (${fecha}) - Hospital Hanga Roa`; }
      if(opt==='3') titleDisplay.innerText='Epicrisis médica';
      if(opt==='4') titleDisplay.innerText='Epicrisis médica de traslado';
      if(opt==='5') titleDisplay.innerText='';
      if(opt==='6') titleDisplay.innerText='Informe médico - Hospital Hanga Roa';
    }

    select.addEventListener('change', ()=>{
      // Cuando cambia la plantilla, ajustamos el título y secciones por defecto
      setTitleFromSelect();
      if(select.value==='6'){
        // Plantilla "Informe médico": solo Antecedentes + sección en blanco sin título
        setSectionsHTML(`
          <div class="sec" data-section><button class="sec-del" title="Eliminar sección">×</button><div class="subtitle" contenteditable="true">Antecedentes</div><textarea class="txt"></textarea></div>
          <div class="sec" data-section><button class="sec-del" title="Eliminar sección">×</button><div class="subtitle" contenteditable="true"></div><textarea class="txt"></textarea></div>
        `);
      } else if(select.value==='2'){
        // Evolución: plantilla clínica completa
        restoreClinicalSections();
      }
    });

    if(fechaInput) fechaInput.addEventListener('input', ()=>{
      // Mantener sincronizado el título con la "Fecha del informe" cuando sea Evolución médica
      if(select.value==='2') setTitleFromSelect();
      if(fecnac?.value) edad.value=calcEdadY(fecnac.value, fechaInput.value);
    });
    if(fecnac) fecnac.addEventListener('input', ()=>{ edad.value=calcEdadY(fecnac.value, fechaInput?.value); });

    // ====== edición de secciones ======
    const sheet=document.getElementById('sheet');
    const container=document.getElementById('sectionsContainer');
    const toggleEdit=document.getElementById('toggleEdit');
    const editPanel=document.getElementById('editPanel');
    const addSecBtn=document.getElementById('addSecBtn');
    const delSecBtn=document.getElementById('delSecBtn');
    const restoreBtn=document.getElementById('restoreBtn');

    function bindDeleteButtons(scope=document){ scope.querySelectorAll('.sec[data-section] .sec-del').forEach(btn=>{ btn.onclick=(e)=>{ e.preventDefault(); btn.closest('.sec').remove(); }; }); }

    function addSection(){
      const sec=document.createElement('div');
      sec.className='sec'; sec.setAttribute('data-section','');
      sec.innerHTML=`<button class="sec-del" title="Eliminar sección">×</button><div class="subtitle" contenteditable="true">Sección personalizada</div><textarea class="txt"></textarea>`;
      container.appendChild(sec); bindDeleteButtons(sec); sec.scrollIntoView({behavior:'smooth', block:'start'});
    }
    function removeSection(){ const secs=container.querySelectorAll('.sec[data-section]'); if(secs.length){ secs[secs.length-1].remove(); } }

    function setSectionsHTML(html){ container.innerHTML=html; bindDeleteButtons(container); }

    function restoreClinicalSections(){
      setSectionsHTML(`
        <div class="sec" data-section><button class="sec-del" title="Eliminar sección">×</button><div class="subtitle" contenteditable="true">Antecedentes</div><textarea class="txt"></textarea></div>
        <div class="sec" data-section><button class="sec-del" title="Eliminar sección">×</button><div class="subtitle" contenteditable="true">Historia y evolución clínica</div><textarea class="txt"></textarea></div>
        <div class="sec" data-section><button class="sec-del" title="Eliminar sección">×</button><div class="subtitle" contenteditable="true">Exámenes complementarios</div><textarea class="txt"></textarea></div>
        <div class="sec" data-section><button class="sec-del" title="Eliminar sección">×</button><div class="subtitle" contenteditable="true">Diagnósticos</div><textarea class="txt"></textarea></div>
        <div class="sec" data-section><button class="sec-del" title="Eliminar sección">×</button><div class="subtitle" contenteditable="true">Plan</div><textarea class="txt"></textarea></div>
      `);
    }

    // ====== campos paciente: agregar / eliminar / restaurar ======
    const patientGrid=document.getElementById('patientGrid');
    const addPatientFieldBtn=document.getElementById('addPatientFieldBtn');
    const restorePatientBtn=document.getElementById('restorePatientBtn');

    function bindPatientRowDeletes(scope=document){
      scope.querySelectorAll('#patientGrid .row .row-del').forEach(btn=>{
        btn.onclick=(e)=>{ e.preventDefault(); const row=btn.closest('.row'); if(row) row.remove(); };
      });
    }

    function addPatientField(){
      const row=document.createElement('div'); row.className='row'; row.setAttribute('data-field','');
      row.innerHTML=`<div class="lbl" contenteditable="true">Nuevo campo</div><input class="inp" type="text"><button class="row-del" title="Eliminar este campo">×</button>`;
      patientGrid.appendChild(row); bindPatientRowDeletes(row); row.scrollIntoView({behavior:'smooth', block:'center'});
    }

    function restorePatientDefaults(){
      patientGrid.innerHTML=`
        <div class="row" data-field><div class="lbl" contenteditable="true">Nombre</div><input class="inp" id="nombre" placeholder="Nombre Apellido"><button class="row-del" title="Eliminar este campo">×</button></div>
        <div class="row" data-field><div class="lbl" contenteditable="true">Rut</div><input class="inp" id="rut"><button class="row-del" title="Eliminar este campo">×</button></div>
        <div class="row" data-field><div class="lbl" contenteditable="true">Fecha de nacimiento</div><input type="date" class="inp" id="fecnac"><button class="row-del" title="Eliminar este campo">×</button></div>
        <div class="row" data-field><div class="lbl" contenteditable="true">Edad</div><input type="number" class="inp" id="edad" placeholder="años"><button class="row-del" title="Eliminar este campo">×</button></div>
        <div class="row" data-field><div class="lbl" contenteditable="true">Fecha de ingreso</div><input type="date" class="inp" id="fing"><button class="row-del" title="Eliminar este campo">×</button></div>
        <div class="row" data-field><div class="lbl" contenteditable="true">Fecha del informe</div><input type="date" class="inp" id="finf"><button class="row-del" title="Eliminar este campo">×</button></div>`;
      bindPatientRowDeletes(patientGrid);
    }

    if(addPatientFieldBtn) addPatientFieldBtn.addEventListener('click', addPatientField);
    if(restorePatientBtn) restorePatientDefaults(); // inicializa y luego permite restaurar
    if(restorePatientBtn) restorePatientBtn.addEventListener('click', restorePatientDefaults);

    function restoreDefault(){
      restoreClinicalSections();
      // Limpia campos y restaura campos paciente
      document.querySelectorAll('.txt').forEach(t=>t.value='');
      document.querySelectorAll('.inp').forEach(i=>{ if(i.type!=='date'&&i.type!=='number'&&i.id!=='') i.value=''; });
      restorePatientDefaults();
      select.value='2'; setTitleFromSelect();
      if(edad) edad.value='';
    }

    toggleEdit.addEventListener('click', ()=>{
      const on=!sheet.classList.contains('edit-mode');
      sheet.classList.toggle('edit-mode', on);
      editPanel.style.display=on?'flex':'none';
    });
    addSecBtn.addEventListener('click', addSection);
    delSecBtn.addEventListener('click', removeSection);
    restoreBtn.addEventListener('click', restoreDefault);

    // ====== Exportar / Importar JSON  (corregido) ======
    function getModel(){
      const patientFields = Array.from(document.querySelectorAll('#patientGrid .row')).map(row=>({
        label: row.querySelector('.lbl')?.innerText?.trim() || '',
        id: row.querySelector('input')?.id || '',
        type: row.querySelector('input')?.type || 'text',
        value: row.querySelector('input')?.value || ''
      }));
      const sections = Array.from(document.querySelectorAll('#sectionsContainer > .sec')).map(sec=>({
        title: (sec.querySelector('.subtitle')?.innerText || '').trim(),
        content: (sec.querySelector('textarea')?.value || '')
      }));
      return {
        version: 'v12',
        template: select.value,
        title: document.getElementById('titleDisplay').innerText.trim(),
        patientFields,
        medico: document.getElementById('medico').value || '',
        especialidad: document.getElementById('esp').value || '',
        sections
      };
    }
    function setModel(model){
      // plantilla y título
      if(model.template) { select.value = String(model.template); setTitleFromSelect(); }
      if(typeof model.title==='string') document.getElementById('titleDisplay').innerText = model.title;
      // campos paciente
      if(Array.isArray(model.patientFields)){
        patientGrid.innerHTML='';
        model.patientFields.forEach(f=>{
          const row=document.createElement('div'); row.className='row'; row.setAttribute('data-field','');
          const inputType = ['text','date','number'].includes(f.type)?f.type:'text';
          const idAttr = f.id?`id="${f.id}"`:'';
          row.innerHTML=`<div class="lbl" contenteditable="true">${f.label||''}</div><input class="inp" ${idAttr} type="${inputType}" value="${(f.value||'').replace(/"/g,'&quot;')}"><button class="row-del" title="Eliminar este campo">×</button>`;
          patientGrid.appendChild(row);
        });
        bindPatientRowDeletes(patientGrid);
      }
      // secciones
      if(Array.isArray(model.sections)){
        container.innerHTML='';
        model.sections.forEach(s=>{
          const sec=document.createElement('div'); sec.className='sec'; sec.setAttribute('data-section','');
          sec.innerHTML=`<button class="sec-del" title="Eliminar sección">×</button><div class="subtitle" contenteditable="true">${s.title||''}</div><textarea class="txt">${(s.content||'').replace(/</g,'&lt;')}</textarea>`;
          container.appendChild(sec);
        });
        bindDeleteButtons(container);
      }
      // médico
      document.getElementById('medico').value = model.medico || '';
      document.getElementById('esp').value = model.especialidad || '';
    }

    document.getElementById('exportJson').addEventListener('click', ()=>{
      const data = getModel();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'registro_clinico.json';
      a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    });
    document.getElementById('importJson').addEventListener('change', (ev)=>{
      const file = ev.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => { try{ const model = JSON.parse(reader.result); setModel(model); }catch(e){ alert('Archivo inválido. Debe ser JSON exportado por esta plantilla.'); } };
      reader.readAsText(file); ev.target.value = '';
    });

    // ====== Nombre sugerido para PDF ======
    function stripAccents(s){return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');}
    function baseNameFromSelect(){switch(select.value){case '1':return'Informe medico';case '2':return'Evolucion medica';case '3':return'Epicrisis';case '4':return'Epicrisis traslado';case '5':return'Registro Clinico';case '6':return'Informe medico';default:return'Registro Clinico';}}
    function patientNameForFile(){const full=(document.getElementById('nombre')?.value||'').trim();if(!full)return'';const parts=full.split(/\s+/);return parts.slice(0,2).join(' ');} 
    function todayDMY(){const now=new Date();const dd=String(now.getDate()).padStart(2,'0');const mm=String(now.getMonth()+1).padStart(2,'0');const yy=String(now.getFullYear()).slice(-2);return`${dd}-${mm}-${yy}`;}
    function suggestedFilename(){const base=baseNameFromSelect();const name=patientNameForFile();const date=todayDMY();const parts=[base,name,date].filter(Boolean).join(' - ');return stripAccents(parts).replace(/[^A-Za-z0-9 _\-]/g,'');}
    const btnPrint=document.getElementById('btnPrint');
    if(btnPrint){btnPrint.addEventListener('click',()=>{const oldTitle=document.title;const newTitle=suggestedFilename()||oldTitle;document.title=newTitle;window.print();setTimeout(()=>{document.title=oldTitle;},1200);});}

    // Inicialización
    function init(){ restoreClinicalSections(); setTitleFromSelect(); bindDeleteButtons(); bindPatientRowDeletes(); }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
